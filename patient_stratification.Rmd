---
title: "Patient Stratification in Heart Failure Using K-Means Clustering"
author: "Philipe Mota"
output: html_document
---
____________________________________________________________________________________________________________________________

## Introduction

Cardiovascular diseases are the leading cause of death worldwide, with heart failure being a major contributor to mortality.
Beyond supervised prediction models, unsupervised learning techniques can help identify latent patient profiles and clinical risk patterns.

In this project, we perform an exploratory data analysis (EDA) followed by K-means clustering to stratify heart failure patients
based on clinical and laboratory variables. The objective is not to predict mortality directly, but to explore the data structure
and assess whether distinct patient groups with different risk characteristics emerge from the dataset.
_____________________________________________________________________________________________________________________________

## Data Loading and Setup

```{r message=FALSE, warning=FALSE}
#Load necessary libraries

library(readr) # For reading CSV files
library(dplyr) # For data manipulation
library(corrplot) # For correlation plot
library(GGally)
library(reshape2)


#Load dataset
#df <- readr::read_csv("dataset.csv")

#Inspect first few rows to confirm proper loading
head(df)

```
_____________________________________________________________________________________________________________________________

## Exploratory Data Analysis (EDA)

1 - Descriptive statistics of continuous variables

```{r}
#Summary statistics: min, 1st quartile, median, mean, 3rd quartile, max
df %>%
  select(age, creatinine_phosphokinase, ejection_fraction,
         platelets, serum_creatinine, serum_sodium, time) %>%
  summary()

```

2 - Calculate the proportion of '1' cases for each binary variable.

```{r}

#For binary variables, the mean equals the proportion of '1's

df %>%
  select(anaemia, diabetes, high_blood_pressure, sex, smoking, DEATH_EVENT) %>%
  summarise_all(mean)

```
3 - Boxplots help to identify extreme outliers.

```{r}
par(mfrow = c(1, 3)) #Organize 3 plots in a single row

#Boxplots for variables suspected to have extreme outliers
boxplot(df$creatinine_phosphokinase, main = "CPK")
boxplot(df$serum_creatinine, main = "Serum Creatinine")
boxplot(df$platelets, main = "Platelets")

```
4 - Log transformation for skewed variables

Several laboratory variables exhibited highly right-skewed distributions, with extreme values well above the upper quartile.
To reduce skewness while preserving clinical ordering, logarithmic transformation was applied to creatinine phosphokinase,
serum creatinine, and platelet count.

```{r}
#Visual check after log-transform
par(mfrow = c(1, 3))

boxplot(log(df$creatinine_phosphokinase), main = "CPK")
boxplot(log(df$serum_creatinine), main = "Serum Creatinine")
boxplot(log(df$platelets), main = "Platelets")

```

```{r}
#Create new columns with log-transformed values for clustering
df$log_creatinine_phosphokinase <- log(df$creatinine_phosphokinase)
df$log_serum_creatinine <- log(df$serum_creatinine)
df$log_platelets <- log(df$platelets)

```
5 - Histograms of continuous variables

Allows you to visualize distribution and identify skew.

```{r}
par(mfrow=c(2,4))
hist(df$age, main="Age", xlab = "Age", col="lightblue", breaks=15)
hist(df$log_creatinine_phosphokinase, main="Log(CPK)", xlab = "CPK",  col="lightgreen", breaks=15)
hist(df$ejection_fraction, main="Ejection Fraction", xlab = "Ejection Fraction",  col="lightpink", breaks=15)
hist(df$log_platelets, main="Log(Platelets)", xlab = "Platelets",  col="lightyellow", breaks=15)
hist(df$log_serum_creatinine, main="Log(Serum Creatinine)", xlab = "Creatinine",  col="lightcyan", breaks=15)
hist(df$serum_sodium, main="Serum Sodium", xlab = "Serum Sodium",  col="lightcoral", breaks=15)
hist(df$time, main="Time", xlab = "CPK",  col="lightgray", breaks=15)
```
6 - Correlation Matrix

Assesses the strength and direction of the relationship between variables
Useful for identifying patterns and multicollinearity

```{r}
numeric_vars <- df %>%
  select(age, log_platelets, ejection_fraction, log_serum_creatinine, serum_sodium)

corr_matrix <- cor(numeric_vars)
corrplot(corr_matrix, method="color", addCoef.col="Black", tl.cex=0.8)
```

7 - Summary table by death

Compare medians of continuous variables between patients who survived (0) and died (1)
Allows identification of important clinical patterns

```{r}
df %>%
  group_by(DEATH_EVENT) %>%
  summarise(
    age_med = median(age),
    cpk_med = median(creatinine_phosphokinase),
    ef_med = median(ejection_fraction),
    platelets_med = median(platelets),
    creat_med = median(serum_creatinine),
    sodium_med = median(serum_sodium),
    time_med = median(time)
  )
```
____________________________________________________________________________________________________________________________

## K-Means Clustering
____________________________________________________________________________________________________________________________

1 - Select variables for clustering

```{r}
# We'll use continuous variables, with log-transform for skewed ones.
cluster_vars <- df %>%
  select(age, ejection_fraction, serum_sodium, log_creatinine_phosphokinase, log_serum_creatinine, log_platelets)

# Scale variables to mean=0 and sd=1
# This ensures all variables contribute equally to distance calculations
cluster_scaled <- scale(cluster_vars)

```

2 - Determine optimal number of clusters

```{r}
# Elbow method: plots total within-cluster sum of squares (WSS) for k = 1:10
wss <- numeric(10)  # empty vector for within-cluster sum of squares

for(k in 1:10){
  set.seed(123)
  km <- kmeans(cluster_scaled, centers = k, nstart = 25)
  wss[k] <- km$tot.withinss
}

plot(1:10, wss, type="b", pch=19, frame=FALSE,
     xlab="Number of clusters K",
     ylab="Total within-clusters sum of squares",
     main="Elbow Method for Optimal K")
```

3 - Fit K-means model

```{r}
set.seed(123)
kmeans_model <- kmeans(cluster_scaled, centers = 3, nstart = 25)

# Add cluster assignments to original dataframe
df$cluster <- as.factor(kmeans_model$cluster)
```

4 - Visualize clusters (pairwise scatterplots)

```{r message=FALSE, warning=FALSE}
ggpairs(df,
        columns = c("age", "ejection_fraction", "serum_sodium",
                    "log_creatinine_phosphokinase", "log_serum_creatinine", "log_platelets"),
        mapping = ggplot2::aes(color = cluster, alpha = 0.5)) +
  theme_bw()
```
5 - Boxplots by cluster

```{r}
df_melt <- melt(df, id.vars = "cluster",
                measure.vars = c("age", "ejection_fraction", "serum_sodium",
                                 "log_creatinine_phosphokinase", "log_serum_creatinine", "log_platelets"))

ggplot(df_melt, aes(x = cluster, y = value, fill = cluster)) +
  geom_boxplot() +
  facet_wrap(~variable, scales = "free") +
  theme_bw() +
  labs(title = "Distribution of Variables by Cluster")
```

```{r}
ggplot(df, aes(x = df$cluster, y = df$time)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  theme_minimal() +
  labs(title = "GrÃ¡fico de Barras", x = "Categoria", y = "Valores")
```

